<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/roboto-fontface@0.10.0/css/roboto/roboto-fontface.min.css">
    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@5.3.45/css/materialdesignicons.min.css">
    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vuetify@2.3.6/dist/vuetify.min.css">
</head>

<body>
    <div id="app">
        <v-app>
            <v-content>
                <v-container>

                    <v-row justify="center">
                        <v-col cols="12">
                            <v-row class="mb-5">
                                <h1 class="mt-5 font-weight-bold"> REF 2021 Outputs: <span v-for="(item, index) in items" v-if="index == 0" class="font-weight-black">Reviewer {{item.reviewer}}</span></h1>
                            </v-row>
                        </v-col>
                        <v-col cols="12" md="11">
                            <v-row>
                                <p v-for="(item, index) in items" v-if="index == 0">
                                    Below is a list of outputs that could potentially be included in City's <a href="https://www.ref.ac.uk/panels/units-of-assessment/" target="_blank">B-11 Unit of Assessment</a> (i.e., Computer Science), <a href="https://ref.ac.uk/about/"
                                        target="_blank">REF 2021</a> submission.
                                </p>
                                <p>
                                    Please review each output and use the selection menus to <em>score</em> them and <em>rate your confidence</em> for each score. After reviewing the outputs please <em>complete the questions</em> below the table.
                                </p>
                            </v-row>
                        </v-col>
                        <v-col cols="10" md="10">
                            <v-row :align="alignment">
                                <p>
                                    The REF scoring is as follows (also see <a href="https://www.ref.ac.uk/publications/guidance-on-submissions-201901/" target="_blank">REF 2021 guidance</a> Appendix A).
                                </p>
                                TABLE
                                <p>
                                    We have added extra increments for the 3* score so you can indicate whether the output might be close to 4* or 2*.
                                </p>
                            </v-row>
                        </v-col>
                    </v-row>

                    <v-row justify="center">
                        <v-col cols="12">
                            <v-card>

                                <v-data-table disable-pagination hide-default-footer show-expand dense :sort-by="sortBy" mobile-breakpoint="800" class="elevation-0" :loading="loading" :headers="headers" :items="items" :single-expand="singleExpand" :expanded.sync="expanded">

                                    <!-- Expand icon/column -->
                                    <template v-slot:item.data-table-expand="{item, isExpanded, expand}">
                                        <v-icon small @click="expand(true)" v-if="!isExpanded" color="primary">mdi-arrow-right</v-icon>
                                        <v-icon small @click="expand(false)" v-if="isExpanded" color="primary">mdi-arrow-bottom-right</v-icon>
                                    </template>

                                    <!-- reviewerScore Column -->
                                    <template v-slot:item.reviewerScore="props">
                                        <v-col cols="8" xl="8" lg="10" md="12" sm="12">
                                            <v-select
                                                :items="refscores"
                                                v-model="props.item.reviewerScore"
                                                dense
                                                label="Score"
                                                class="text-center"
                                                @click="open('Score the output')"
                                                @input="saveItem(props.item,'reviewerScore'),save('Rank saved')"
                                            ></v-select>
                                        </v-col>
                                    </template>

                                    <!-- reviewerConfidence Column -->
                                    <template v-slot:item.reviewerConfidence="props">
                                        <v-col cols="8" xl="8" lg="10" md="12" sm="12">
                                            <v-select
                                                :items="confidence"
                                                v-model="props.item.reviewerConfidence"
                                                dense
                                                label="Rate"
                                                class="text-center"
                                                @click="open('Rate your confidence in the score')"
                                                @input="saveItem(props.item,'reviewerConfidence'),save('Confidence saved')"
                                            ></v-select>
                                        </v-col>
                                    </template>

                                    <!-- Ouput Column -->
                                    <template v-slot:item.output="props">
                                        <div>
                                            <a class="font-weight-medium" :href="'http://dx.doi.org/' + props.item.doi" target="_new">{{props.item.title}}</a> ({{props.item.year}}) <em>{{props.item.source}}</em> <a :href="'http://dx.doi.org/' + props.item.doi" target="_new">DOI</a>
                                        </div>
                                    </template>

                                    <!-- Hundred Words Column -->
                                    <template v-slot:item.hundredwords="props">
                                        <div>{{props.item.hundredWords}}</div>
                                    </template>

                                    <!-- Citations column -->
                                    <template v-slot:item.crossref="props">
                                        <v-tooltip bottom>
                                            <template v-slot:activator="{ on, attrs }">
                                                <span v-bind="attrs" v-on="on">
                                                    {{props.item.crossRef}}
                                                </span>
                                            </template>
                                    <div>From CrossRef api.
                                        <p class="mt-2 font-italic" target="_blank">Only retrieved with valid DOI.</p>
                                    </div>
                                    </v-tooltip>
                                    <v-tooltip bottom v-if="props.item.scopus">
                                        <template v-slot:activator="{ on, attrs }">
                                                <span v-bind="attrs" v-on="on">
                                                    / {{props.item.scopus}}
                                                </span>
                                            </template>
                                        <div>From Elsiver/Scopus api.
                                            <p class="mt-2 font-italic" target="_blank">Only retrieved with valid DOI.</p>
                                        </div>
                                    </v-tooltip>
                                    </template>

                                    <!-- Source Column -->
                                    <template v-slot:item.sourcescore="props">
                                        <span>
                                            <v-tooltip bottom>
                                                <template v-slot:activator="{ on, attrs }">
                                                    <span v-bind="attrs" v-on="on" class="text-truncate">{{ props.item.citeScore }}</span>
                                                </template>
                                    <p class="text-center">CiteScore: using Elsiver's journal metric</p>
                                    </v-tooltip>
                                    </span>
                                    <span v-if="props.item.sjr">
                                            <v-tooltip bottom>
                                                <template v-slot:activator="{ on, attrs }">
                                                    <span v-bind="attrs" v-on="on">
                                                        <span v-bind="attrs" v-on="on" class="text-truncate"> / {{props.item.sjr}}</span>
                                    </span>
                                    </template>
                                    <p class="mt-2 font-italic" target="_blank">SJR: SCImago journal rank</p>
                                    </v-tooltip>
                                    </span>
                                    </template>

                                    <!-- Expanded row -->
                                    <template v-slot:expanded-item="{ headers, item }">
                                        <td :colspan="headers.length" :id="item.lastName + item.doi">
                                            <div class="mt-2">
                                                <p><strong>Author(s):</strong> {{ item.authors }}<br>
                                                    <strong>Year:</strong> {{ item.year }}<br>
                                                    <strong>Title:</strong> {{ item.title }}<br>
                                                    <strong v-if="item.source">Conference/Journal:</strong> {{ item.source }}</p>
                                                <p v-if="item.doi">
                                                    <span v-if="item.crossRef"><strong>Citations</strong> (<a href="https://www.crossref.org/education/retrieve-metadata/rest-api/">Crossref API</a>): <strong>{{ item.crossRef }}</strong><br></span>
                                                    <span v-if="item.scopus"></span><strong>Citations</strong> (<a href="https://dev.elsevier.com">Elsiver/Scopus API</a>): <strong>{{ item.scopus }}</strong><br></span>
                                                    See google scholar <a :href="'https://scholar.google.com/scholar?q=' + item.doi" target="_blank">here</a>.
                                                </p>
                                                <p v-if="item.citeScore">
                                                    <strong>Journal CiteScore</strong> (<a href="https://www.elsevier.com/editors-update/story/journal-metrics/citescore-a-new-metric-to-help-you-choose-the-right-journal" target="_blank" rel="noopener noreferrer">Elsiver</a>): <strong>{{ item.citeScore }}</strong>
                                                    <span v-if="item.sjr"><br><strong>Journal rank</strong> (<a href="https://www.scimagojr.com/aboutus.php" target="_blank" rel="noopener noreferrer">SJR</a>): <strong>{{ item.sjr }}</strong></span>
                                                </p>
                                            </div>
                                        </td>
                                    </template>

                                </v-data-table>

                                <!-- Snack bar save messages -->
                                <v-snackbar v-model="snack" :timeout="3000" :color="snackColor">
                                    <div class="text-center">{{ snackText }}</div>
                                </v-snackbar>

                            </v-card>
                        </v-col>
                    </v-row>

                </v-container>
            </v-content>
        </v-app>
    </div>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/vue@2.6.11/dist/vue.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/vuetify@2.3.6/dist/vuetify.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/axios@0.19.2/dist/axios.min.js"></script>
    <script>
        const apiToken = "keyAKLpRf8ec2XWH9",
            airTableApp = "appunQ0V4X7SQIIk7",
            airTableName = "tblDN6QUoVueC6fkg",
            airTableView = "viwH3RIyw6VZCf9jx";
        new Vue({
            el: '#app',
            vuetify: new Vuetify(),
            data() {
                return {
                    headers: [{
                        text: '',
                        value: 'data-table-expand'
                    }, {
                        text: 'Score',
                        value: 'reviewerscore',
                        align: 'center',
                        width: '12%'
                    }, {
                        text: 'Confidence',
                        value: 'reviewerconfidence',
                        align: 'center',
                        width: '14%'
                    }, {
                        text: 'Output',
                        value: 'output',
                        width: '28%',
                        sortable: false
                    }, {
                        text: "100 word summary",
                        value: "hundredwords",
                        sortable: false,
                        width: '36%'
                    }, {
                        text: "Citations",
                        value: "crossref",
                        align: 'center',
                        width: '10%',
                        sortable: false
                    }],
                    refscores: ['4*', '3* +', '3*', '3* -', '2*', '1*'],
                    confidence: ['High', 'Medium', 'Low'],
                    loading: true,
                    expanded: [],
                    singleExpand: true,
                    snack: false,
                    snackColor: '',
                    snackText: '',
                    sortBy: 'title',
                    items: [],
                    cites: "",
                    alignment: 'center',
                    dialog: false // used to toggle the dialog
                }
            },
            mounted() {
                this.loadItems()
            },
            methods: {
                loadItems() {
                    let url = new URL(window.location.href);
                    let reviewer = url.searchParams.get("reviewer");
                    const fields = "fields%5B%5D=authorID&fields%5B%5D=authorName&fields%5B%5D=title&fields%5B%5D=firstName&fields%5B%5D=lastName&fields%5B%5D=year&fields%5B%5D=source&fields%5B%5D=authors&fields%5B%5D=type&fields%5B%5D=ref&fields%5B%5D=doi&fields%5B%5D=hundredWords&fields%5B%5D=specialism&fields%5B%5D=crossRef&fields%5B%5D=scopus&fields%5B%5D=refScore&fields%5B%5D=issn&fields%5B%5D=isbn&fields%5B%5D=citeScore&fields%5B%5D=sourceID&fields%5B%5D=sjr&fields%5B%5D=reviewer&fields%5B%5D=reviewerScore&fields%5B%5D=reviewerID&fields%5B%5D=reviewerConfidence";
                    const sort = "sort%5B0%5D%5Bfield%5D=lastName&sort%5B0%5D%5Bdirection%5D=asc";
                    let submissionURL = `https://api.airtable.com/v0/${airTableApp}/${airTableName}?view=${airTableView}&${fields}&${sort}&filterByFormula=FIND(%22recgIBTqnDdv4a0J6%22%2C%7BreviewerID%7D)`;
                    this.items = [];
                    console.log(submissionURL);
                    axios.get(submissionURL, {
                        headers: {
                            Authorization: "Bearer " + apiToken
                        }
                    }).then((response) => {
                        this.items = response.data.records.map((item) => {
                            return {
                                id: item.id,
                                ...item.fields
                            }
                        })
                        this.loading = false; // Removes table loader graphic
                    }).catch((error) => {
                        console.log(error)
                    })
                },
                saveItem(item, key) {
                    let data = item,
                        method = "patch",
                        id = item.id,
                        url = `https://api.airtable.com/v0/${airTableApp}/${airTableName}/${id}`;

                    if (key === "reviewerScore") {
                        data = {
                            fields: {
                                reviewerScore: item.reviewerScore
                            }
                        }
                    } else if (key === "reviewerConfidence") {
                        data = {
                            fields: {
                                reviewerConfidence: item.reviewerConfidence
                            }
                        }
                    }
                    axios[method](url,
                        data, {
                            headers: {
                                Authorization: "Bearer " + apiToken,
                                "Content-Type": "application/json"
                            },
                            transformRequest: [(data) => {
                                if (data.fields.id) {
                                    delete data.fields.id // must remove id from the data for airtable patch to work
                                }
                                if (key === "saveFormItem") {
                                    delete data.fields.firstName; // must remove all computed fields if saving entire record
                                    delete data.fields.lastName;
                                    delete data.fields.authorName;
                                    delete data.fields.authorID;
                                    //delete data.fields.Centre
                                }
                                return JSON.stringify(data);
                            }]
                        }
                    ).then(response => {
                        if (response.data && response.data.id) {
                            this.editedItem.id = response.data.id
                            if (!id) {
                                this.items.push(this.editedItem)
                            }
                            this.editedItem = {}
                        }
                        if (key === "saveFormItem") {
                            this.dialog = !this.dialog;
                            setTimeout(function() {
                                location.reload();
                            }, 500)
                        }
                    }).catch(error => {
                        console.log(error.response)
                    })
                },
                save(msg) {
                    this.snack = true;
                    this.snackColor = 'success';
                    this.snackText = msg || 'Change uploaded'
                },
                cancel(msg) {
                    this.snack = true;
                    this.snackColor = 'error';
                    this.snackText = msg || 'Not uploaded'
                },
                open(msg) {
                    this.snack = true;
                    this.snackColor = 'info';
                    this.snackText = msg || 'Dialog opened'
                },
                close(msg) {
                    this.snack = true;
                    this.snackColor = 'error';
                    this.snackText = msg || 'Not uploaded'
                }
            }
        })
    </script>
</body>

</html>