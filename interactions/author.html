<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.0/css/bootstrap.min.css" integrity="sha384-SI27wrMjH3ZZ89r4o+fGIJtnzkAnFs3E4qz9DIYioCQ5l9Rd/7UAa8DHcaL8jkWt" crossorigin="anonymous">
    <link rel="stylesheet" href="./css/styles.css">
    <title>interactions magazine | Author</title>
</head>

<body>
    <main>
        <div class="container">

            <div class="row justify-content-center align-items-center" id="page-title">
                <div class="col-12 col-md-3 my-md-5 mt-5 order-md-5">
                    <a href="https://interactions.acm.org">
                        <img class="float-right" src="https://interactions.acm.org/images/logo.gif" alt="interactions magazine logo" width="160px">
                    </a>
                </div>
                <div class="col-12 col-md-7">
                    <h1 class="font-weight-bold my-5">interactions Magazine</h1>
                </div>
            </div>

            <div class="row justify-content-center" id="author-title">
                <div class="col-12 col-md-10">
                    <h2 class="font-weight-bold mb-3">Author details</h2>
                </div>
            </div>

            <div class="row justify-content-center my-3" id="author-details">
                <div class="col-12 col-md-10">
                    <div id="app-auth">
                        <div v-for="(item, index) in items">
                            <div v-if="index == 0" id="author">
                                <table class="table table-bordered table-hover">
                                    <tbody>

                                        <tr>
                                            <th class="align-middle" width="25%" scope="row">Contact Author</th>
                                            <td class="align-middle border-right-0" width="65%">
                                                <div v-if="item['fields']['Name']">
                                                    <p class="lbr font-weight-bold my-2">{{ item['fields']['Name'] }}</p>
                                                </div>
                                            </td>
                                            <td class="align-middle border-left-0" width="10%">
                                            </td>
                                        </tr>

                                        <tr v-if="item['fields']['Photo']">
                                            <th class="align-middle" width="25%" scope="row">Photo</th>
                                            <td class="align-middle border-right-0" width="65%">
                                                <div>

                                                    <button type="button" class="btn btn-sm btn-primary" data-toggle="modal" data-target=".photo-modal-sm">View photo</button>

                                                    <div class="modal fade photo-modal-sm" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true">
                                                        <div class="modal-dialog modal-dialog-centered modal-sm" role="document">
                                                            <div class="modal-content my-2">

                                                                <div class="modal-header">
                                                                    <h5 class="modal-title" id="ModalTitle">{{ item['fields']['Name'] }}</h5>
                                                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                                            <span aria-hidden="true">&times;</span>
                                                                        </button>
                                                                </div>
                                                                <p class="text-center mt-3">
                                                                    <a v-bind:href="item['fields']['Photo']['0']['url']">
                                                                        <img v-bind:src="item['fields']['Photo'][0]['thumbnails']['large']['url']" class="rounded" alt="Thumbnail. Click to download file" width='250' height='250'>
                                                                    </a>
                                                                </p>
                                                            </div>
                                                        </div>
                                                    </div>

                                                </div>
                                            </td>
                                            <td class="align-middle border-left-0" width="10%">
                                            </td>
                                        </tr>

                                        <tr>
                                            <th class="align-middle" width="25%" scope="row">Group</th>
                                            <td class="align-middle border-right-0" width="65%">
                                                <div>
                                                    <p class="lbr my-2" v-if="item['fields']['Group']">{{ item['fields']['Group'] }}</p>
                                                </div>
                                            </td>
                                            <td class="align-middle border-left-0" width="10%">
                                                <div class="text-right">
                                                    <button v-on:click="fieldName = 'Group'" type="button" class="btn btn-sm btn-link" data-toggle="modal" data-target="#updateModal" data-field="Group" data-source="Author" data-placeholder="Group or Lab name..."><span v-if="item['fields']['Group']">update...</span><span v-else>add...</span></button>
                                                </div>
                                            </td>
                                        </tr>

                                        <tr>
                                            <th class="align-middle" width="25%" scope="row">Department</th>
                                            <td class="align-middle border-right-0" width="65%">
                                                <div>
                                                    <p class="lbr my-2" v-if="item['fields']['Department']">{{ item['fields']['Department'] }}</p>
                                                </div>
                                            </td>
                                            <td class="align-middle border-left-0" width="10%">
                                                <div class="text-right">
                                                    <button v-on:click="fieldName = 'Department'" type="button" class="btn btn-sm btn-link" data-toggle="modal" data-target="#updateModal" data-field="Department" data-source="Author" data-placeholder="Department name..."><span v-if="item['fields']['Department']">update...</span><span v-else>add...</span></button>
                                                </div>
                                            </td>
                                        </tr>

                                        <tr>
                                            <th class="align-middle" width="25%" scope="row">Organisation</th>
                                            <td class="align-middle border-right-0" width="65%">
                                                <div>
                                                    <p class="lbr my-2" v-if="item['fields']['Organisation']">{{ item['fields']['Organisation'] }}</p>
                                                </div>
                                            </td>
                                            <td class="align-middle border-left-0" width="10%">
                                                <div class="text-right">
                                                    <button v-on:click="fieldName = 'Organisation'" type="button" class="btn btn-sm btn-link" data-toggle="modal" data-target="#updateModal" data-field="Organisation" data-source="Author" data-placeholder="Organisation name..."><span v-if="item['fields']['Organisation']">update...</span><span v-else>add...</span></button>
                                                </div>
                                            </td>
                                        </tr>

                                        <tr>
                                            <th class="align-middle" width="25%" scope="row">Twitter</th>
                                            <td class="align-middle border-right-0" width="65%">
                                                <div v-if="item['fields']['Twitter']">
                                                    <p class="lbr my-2">{{ item['fields']['Twitter'] }}</p>
                                                </div>
                                            </td>
                                            <td class="align-middle border-left-0" width="10%">
                                                <div class="text-right">
                                                    <button v-on:click="fieldName = 'Twitter'" type="button" class="btn btn-sm btn-link" data-toggle="modal" data-target="#updateModal" data-field="Twitter" data-source="Author" data-placeholder="Twitter handle..."><span v-if="item['fields']['Twitter']">update...</span><span v-else>add...</span></button>
                                                </div>
                                            </td>
                                        </tr>

                                        <tr>
                                            <th class="align-middle" width="25%" scope="row">Bio</th>
                                            <td class="align-middle border-right-0" width="65%">
                                                <div>
                                                    <p class="lbr my-2" v-if="item['fields']['Short Bio']">{{ item['fields']['Short Bio'] }}</p>
                                                </div>
                                            </td>
                                            <td class="align-middle border-left-0" width="10%">
                                                <div class="text-right">
                                                    <button v-on:click="fieldName = 'Short Bio'" type="button" class="btn btn-sm btn-link" data-toggle="modal" data-target="#updateModal" data-field="Short Bio" data-source="Author" data-placeholder="Short Bio..."><span v-if="item['fields']['Short Bio']">update...</span><span v-else>add...</span></button>
                                                </div>
                                            </td>
                                        </tr>

                                        <tr>
                                            <th class="align-middle" width="25%" scope="row">Postal Address</th>
                                            <td class="align-middle border-right-0" width="65%">
                                                <div v-if="item['fields']['Postal Address']">
                                                    <p class="lbr my-2">{{ item['fields']['Postal Address'] }}</p>
                                                </div>
                                            </td>
                                            <td class="align-middle border-left-0" width="10%">
                                                <div class="text-right">
                                                    <button v-on:click="fieldName = 'Postal Address'; airtableTable = 'Author'" type="button" class="btn btn-sm btn-link" data-toggle="modal" data-target="#updateModal" data-field="Postal Address" data-source="Author" data-placeholder="Postal Address..."><span v-if="item['fields']['Postal Address']">update...</span><span v-else>add...</span></button>
                                                </div>
                                            </td>
                                        </tr>

                                    </tbody>
                                </table>
                            </div>
                            <div v-else class="my-5 text-center">
                                <p>The author details didn't load properly. Try <a href="javascript:window.location.reload();">refreshing the page.</a></p>
                            </div>
                        </div>

                        <div class="modal fade" id="updateModal" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
                            <div class="modal-dialog" role="document">
                                <div class="modal-content">

                                    <div class="modal-header">
                                        <h5 class="modal-title" id="modalLabel">Update</h5>
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                    </div>

                                    <div class="modal-body">
                                        <form id="updateForm" action="" method="get">

                                            <div v-if="fieldName == 'Twitter'" class="input-group" id="updateFormGroup">
                                                <!-- insert @ prepend -->
                                                <div class='input-group-prepend' id='twitterAt'>
                                                    <div class='input-group-text'>@</div>
                                                </div>
                                                <input type="text" name="updateInput" value="" class="form-control" id="updateTwitter" placeholder="">
                                            </div>

                                            <div v-else-if="fieldName == 'Short Bio' || fieldName == 'Postal Address' || fieldName == 'Insights' || fieldName == 'Author Order'" class="form-group" id="updateFormGroup">
                                                <textarea type="text" name="updateInput" value="" class="form-control" id="updateText" rows="6" placeholder=""></textarea>
                                            </div>

                                            <div v-else class="form-group" id="updateFormGroup">
                                                <input type="text" name="updateInput" value="" class="form-control" id="updateInput" placeholder="">
                                            </div>

                                            <div class="form-group mt-3 text-right">
                                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                                <button type="button" class="btn btn-primary" Name="updateButton" value="Click" onClick="submitForm(this.form)" data-dismiss="modal">Update</button>
                                            </div>

                                        </form>
                                    </div>

                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

        </div>
    </main>
    <footer>
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-12 col-md-10">
                    <div class="my-5">
                        <a href="https://interactions.acm.org">
                            <img src="https://interactions.acm.org/images/logo.gif" alt="interactions magazine logo" width="160px">
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </footer>
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.0/js/bootstrap.min.js" integrity="sha384-3qaqj0lc6sV/qpzrc1N5DC6i1VRn/HyX4qdPaiEFbn54VjQBEU341pvjz7Dv3n6P" crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.5.17/vue.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.min.js"></script>
    <script type="text/javascript">
        var app_id = "appgcGlPwTaZaBImL";
        var app_key = "key8l5YZtQ9FyUoxF";
        var app_auth = new Vue({
            el: '#app-auth',
            data: {
                items: []
            },
            mounted: function() {
                this.loadItems();
            },
            methods: {
                loadItems: function() {
                    let url = new URL(window.location.href);
                    let author_rec = url.searchParams.get("aut");
                    let self = this;
                    this.items = []

                    setTimeout(() => {
                        let author_url = "https://api.airtable.com/v0/" + app_id + "/Editors%20%26%20Authors?filterByFormula=FIND(%22" + author_rec + "%22%2CID)&maxRecords=1";

                        axios.get(
                            author_url, {
                                headers: {
                                    Authorization: "Bearer " + app_key
                                }
                            }
                        ).then(response => {}).catch(function(error) {
                            console.log(error);
                        })
                    }, 1200);

                }
            }
        });

        $('#updateModal').on('show.bs.modal', function(event) {
            var button = $(event.relatedTarget); // Button that triggered the modal
            airtableField = button.data('field'); //.replace(/ /g, "_");
            source = button.data('source');
            var placeholder = button.data('placeholder');
            // Extract info from data-* attributes
            // If necessary, you could initiate an AJAX request here (and then do the updating in a callback).
            // Update the modal's content. We'll use jQuery here, but you could use a data binding library or other methods instead.
            var modal = $(this);
            var inputPrepend = "<div class='input-group-prepend' id='twitterAt'><div class='input-group-text'>@</div></div>";

            if (airtableField == 'Twitter' && document.getElementById('twitterAt') === null) {
                //document.getElementById('updateFormGroup').insertAdjacentHTML('afterbegin', inputPrepend);
            }
            modal.find('.modal-title').text(source + ' update');
            modal.find('.form-control').attr('placeholder', placeholder)
                //modal.find('.modal-body label').text(field)
        });

        function submitForm(form) {
            var updateFieldData;
            var updateFieldValue;
            var airtable_write_endpoint;
            console.log(source);

            //let airtable_write_endpoint = "https://api.airtable.com/v0/appgcGlPwTaZaBImL/Editors%20%26%20Authors/" + author_rec + "/?api_key=key8l5YZtQ9FyUoxF";

            if (source == 'Author') {
                airtable_write_endpoint = "https://api.airtable.com/v0/appgcGlPwTaZaBImL/Editors%20%26%20Authors/" + author_rec + "/?api_key=key8l5YZtQ9FyUoxF";
            }

            if (airtableField == 'Twitter') {
                updateFieldValue = "@" + form.updateInput.value;

            } else {
                updateFieldValue = form.updateInput.value;
            }
            var updateFieldData = '{"fields": { "' + airtableField + '": "' + updateFieldValue + '"} }';
            //console.log(updateFieldData);
            updateFieldData = updateFieldData.replace(/\n/g, "\\n").replace(/\r/g, "\\r").replace(/\t/g, "\\t");
            //console.log(updateFieldData);
            updateFieldData = JSON.parse(updateFieldData);
            //console.log(updateFieldData);

            axios.patch(airtable_write_endpoint, updateFieldData);
            setTimeout(function() {
                location.reload();
            }, 2000);
        }
    </script>
</body>

</html>